import re


def clean_note_value(value: str) -> str | None:
    """
    Очищує вхідний рядок примітки, видаляючи префікс "Примітка" (з або без знаку ":" або "."),
    підкреслення, небажані символи (залишаються лише літери, цифри, крапки та пробіли) і зводить усі пробіли до одного.

    Приклади:
      "Примітка:  _______кінець цвітіння"
          -> "кінець цвітіння"
      "Примітка. Опадомір - на ММ, відстань- 0,2 км. Фаза - н.ф.н. Грунтова засуха."
          -> "Опадомір - на ММ відстань 0,2 км Фаза нфн Грунтова засуха"
      "Примітка: Посадка ___"
          -> "Посадка"
      "Примітка:_"
          -> None
    """
    text = str(value).strip()

    # Якщо рядок після префікса "Примітка" (з або без знаку розділового знаку) складається лише із підкреслень або пробілів,
    # повертаємо None
    if re.match(r'(?i)^примітка[:.\s_]+$', text):
        return None

    # Видаляємо префікс "Примітка" з будь-яким розділовим знаком (":", ".", пробіл)
    text = re.sub(r'(?i)^примітка[:.\s]*', '', text).strip()

    # Замінюємо підкреслення на пробіли
    text = text.replace('_', ' ')

    # Дозволяємо лише літери (українські та латинські), цифри, крапки та пробіли
    text = re.sub(r'[^A-Za-zА-Яа-яЁёІіЇїЄєҐґ0-9.\s]', '', text).strip()

    # Зводимо послідовні пробіли до одного
    text = re.sub(r'\s+', ' ', text).strip()

    # (Опційно) Видаляємо зайві знаки пунктуації з кінця рядка
    text = re.sub(r'[.,:;!?]+$', '', text).strip()

    return text if text else None


# Приклади використання:
if __name__ == '__main__':
    example1 = "Примітка. . _______кінець цвітіння"
    example2 = "Примітка. Опадомір - на ММ, відстань- 0,2 км. Фаза - н.ф.н. Грунтова засуха."
    example3 = "Примітка Посадка ___"
    example4 = "Примітка:_"

    print(clean_note_value(example1))  # Очікуємо: "кінець цвітіння"
    print(clean_note_value(example2))  # Очікуємо: "Опадомір - на ММ відстань 0,2 км Фаза нфн Грунтова засуха"
    print(clean_note_value(example3))  # Очікуємо: "Посадка"
    print(clean_note_value(example4))  # Очікуємо: None
